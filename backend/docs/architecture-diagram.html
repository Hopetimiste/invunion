<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramme d'Architecture - Flux de Donn√©es</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        h3 {
            color: #666;
            margin-top: 20px;
        }
        .mermaid {
            background: white;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .priority-p0 { color: #dc3545; font-weight: bold; }
        .priority-p1 { color: #fd7e14; font-weight: bold; }
        .priority-p2 { color: #ffc107; font-weight: bold; }
        .new-feature {
            background: #e7f5e7;
            border-left: 4px solid #28a745;
            padding: 10px;
            margin: 10px 0;
        }
        .security-note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Diagramme d'Architecture - Flux de Donn√©es</h1>
        
        <h2>Vue d'ensemble du syst√®me (Architecture Production-Ready)</h2>
        <div class="mermaid">
graph TB
    %% Styles
    classDef external fill:#f9f,stroke:#333,stroke-width:2px;
    classDef edge fill:#ff6b6b,stroke:#333,stroke-width:2px,color:white;
    classDef ingestion fill:#ffcc00,stroke:#333,stroke-width:2px;
    classDef storage fill:#3399ff,stroke:#333,stroke-width:2px,color:white;
    classDef cache fill:#17a2b8,stroke:#333,stroke-width:2px,color:white;
    classDef process fill:#9933ff,stroke:#333,stroke-width:2px,color:white;
    classDef userzone fill:#00cc66,stroke:#333,stroke-width:2px,color:white;
    classDef security fill:#dc3545,stroke:#333,stroke-width:2px,color:white;
    classDef observability fill:#6c757d,stroke:#333,stroke-width:2px,color:white;

    %% Acteurs Externes
    subgraph External["üåç Sources Externes"]
        Tink[("üè¶ Tink\n(Banques)")]:::external
        ERP[("üìä ERP\n(Factures)")]:::external
        Webhooks[("üì® Webhooks\n(Providers)")]:::external
        ExternalClients[("üîå API Clients\n(CSV/JSON)")]:::external
    end

    %% ZONE 0 : EDGE LAYER (Protection)
    subgraph ZoneEdge["üîí Zone Edge (Protection)"]
        CloudArmor["üõ°Ô∏è Cloud Armor\n(WAF)"]:::edge
        LoadBalancer["‚öñÔ∏è Cloud Load\nBalancer"]:::edge
    end

    %% ZONE S√âCURIT√â
    subgraph ZoneSecurity["üîê Zone S√©curit√©"]
        SecretManager["üîë Secret Manager\n(Credentials)"]:::security
        VPC["üè∞ VPC Priv√©\n(Private IPs)"]:::security
    end

    %% ZONE 1 : INGESTION (Le Bouclier)
    subgraph ZoneIngestion["üõ°Ô∏è Zone Ingestion (Async)"]
        n8n["üêô n8n\n(Orchestrator)"]:::ingestion
        CoreWebhook["üîî Cloud Run\n(Core Webhook)\n+ Idempotency"]:::ingestion
        PubSubIngest[("üì® Pub/Sub\n(Topic: ingest)")]:::ingestion
        IngestWorker["‚öôÔ∏è Cloud Run\n(Ingest Worker)"]:::ingestion
        DLQIngest[("üíÄ Dead Letter\n(Topic: ingest-dlq)")]:::ingestion
    end

    %% ZONE 2 : DATA (Le Coeur)
    subgraph ZoneData["üíæ Zone Donn√©es (VPC Priv√©)"]
        CloudSQL[("üõ¢Ô∏è Cloud SQL HA\n(PostgreSQL)\n+ PITR Backup")]:::storage
        ReadReplica[("üìñ Read Replica\n(Lectures)")]:::storage
        Redis[("‚ö° Memorystore\n(Redis Cache)")]:::cache
    end

    %% ZONE 3 : TRAITEMENT (Le Cerveau)
    subgraph ZoneProcess["üß† Zone Traitement (Worker)"]
        ProcessWorker["‚öôÔ∏è Cloud Run\n(Worker/Jobs)"]:::process
        IAMatch["ü§ñ Vertex AI\n(IA Matching)"]:::process
        PubSubProcess[("üì® Pub/Sub\n(Topic: process)")]:::process
        DLQProcess[("üíÄ Dead Letter\n(Topic: process-dlq)")]:::process
    end

    %% ZONE 4 : UTILISATEUR (La Fa√ßade)
    subgraph ZoneUser["üë§ Zone Utilisateur (API-First)"]
        CoreAPI["üöÄ Cloud Run\n(Core API)\nREST/GraphQL\n+ Rate Limiting"]:::userzone
        Frontend["üíª Frontend\n(React)"]:::userzone
    end

    %% ZONE OBSERVABILIT√â
    subgraph ZoneObs["üìä Zone Observabilit√©"]
        CloudLogging["üìù Cloud Logging"]:::observability
        CloudTrace["üîç Cloud Trace"]:::observability
        CloudMonitoring["üìà Cloud Monitoring"]:::observability
        Alerting["üö® Alerting\n(PagerDuty)"]:::observability
    end

    %% FLUX EDGE
    ExternalClients -- "HTTPS" --> CloudArmor
    Frontend -- "HTTPS" --> CloudArmor
    CloudArmor -- "Filtr√©" --> LoadBalancer
    LoadBalancer -- "Route" --> CoreAPI

    %% FLUX WEBHOOKS (avec Edge)
    Webhooks -- "Webhook Events" --> CloudArmor
    CloudArmor -- "Filtr√©" --> CoreWebhook
    
    %% FLUX BANQUES/ERP via n8n
    Tink -- "JSON Data" --> n8n
    ERP -- "Factures Data" --> n8n
    n8n -- "Push Message" --> PubSubIngest
    
    %% FLUX Core Webhook
    CoreWebhook -- "Validate & Push" --> PubSubIngest
    
    %% FLUX Ingestion vers Data
    PubSubIngest -- "D√©pile (Batch)" --> IngestWorker
    PubSubIngest -. "√âchecs" .-> DLQIngest
    IngestWorker -- "INSERT (Bulk)" --> CloudSQL
    
    %% FLUX Cache
    CoreAPI -- "Cache-aside" --> Redis
    Redis -. "Miss" .-> CloudSQL
    CoreAPI -- "Read (CQRS)" --> ReadReplica

    %% FLUX Traitement
    CloudSQL -- "Trigger" --> PubSubProcess
    PubSubProcess -- "D√©pile" --> ProcessWorker
    PubSubProcess -. "√âchecs" .-> DLQProcess
    ProcessWorker -- "Lit (Unmatched)" --> ReadReplica
    ProcessWorker -- "Appelle IA" --> IAMatch
    IAMatch -- "R√©sultats" --> ProcessWorker
    ProcessWorker -- "UPDATE" --> CloudSQL

    %% FLUX Secrets
    CoreAPI -. "Credentials" .-> SecretManager
    IngestWorker -. "Credentials" .-> SecretManager
    CoreWebhook -. "Credentials" .-> SecretManager

    %% FLUX Observabilit√©
    CoreAPI -. "Logs/Traces" .-> CloudLogging
    IngestWorker -. "Logs/Traces" .-> CloudLogging
    ProcessWorker -. "Logs/Traces" .-> CloudLogging
    CloudLogging --> CloudTrace
    CloudMonitoring --> Alerting

    %% VPC
    CloudSQL -.-> VPC
    ReadReplica -.-> VPC
    Redis -.-> VPC
        </div>

        <h2>üÜï Nouvelles Zones Ajout√©es</h2>

        <div class="new-feature">
            <h3>üîí Zone Edge (Protection) - NOUVEAU</h3>
            <ul>
                <li><strong>Cloud Armor (WAF)</strong> : Protection contre les attaques DDoS, injection SQL, XSS</li>
                <li><strong>Cloud Load Balancer</strong> : Distribution de charge, SSL termination, health checks</li>
            </ul>
        </div>

        <div class="new-feature">
            <h3>üîê Zone S√©curit√© - NOUVEAU</h3>
            <ul>
                <li><strong>Secret Manager</strong> : Stockage s√©curis√© des credentials (API keys Tink, tokens, etc.)</li>
                <li><strong>VPC Priv√©</strong> : Isolation r√©seau, Private Service Connect pour Cloud SQL</li>
            </ul>
        </div>

        <div class="new-feature">
            <h3>‚ö° Cache Layer (Memorystore) - NOUVEAU</h3>
            <ul>
                <li><strong>Redis Cache</strong> : Cache des requ√™tes fr√©quentes (dashboard, listes)</li>
                <li><strong>Pattern Cache-Aside</strong> : CoreAPI interroge Redis d'abord, puis Cloud SQL si miss</li>
            </ul>
        </div>

        <div class="new-feature">
            <h3>üìä Zone Observabilit√© - NOUVEAU</h3>
            <ul>
                <li><strong>Cloud Logging</strong> : Centralisation des logs de tous les services</li>
                <li><strong>Cloud Trace</strong> : Tracing distribu√© pour debug des flux asynchrones</li>
                <li><strong>Cloud Monitoring</strong> : M√©triques, dashboards, SLIs/SLOs</li>
                <li><strong>Alerting</strong> : Int√©gration PagerDuty/Opsgenie pour incidents</li>
            </ul>
        </div>

        <h2>üîÑ Am√©liorations des Zones Existantes</h2>

        <h3>Zone Donn√©es - Am√©liorations</h3>
        <table>
            <tr>
                <th>Composant</th>
                <th>Avant</th>
                <th>Apr√®s</th>
                <th>B√©n√©fice</th>
            </tr>
            <tr>
                <td>Cloud SQL</td>
                <td>Instance simple</td>
                <td>Cloud SQL HA + PITR</td>
                <td>Haute disponibilit√©, recovery point < 5 min</td>
            </tr>
            <tr>
                <td>Lectures</td>
                <td>Direct sur master</td>
                <td>Read Replica d√©di√©</td>
                <td>CQRS, meilleure performance, isolation</td>
            </tr>
            <tr>
                <td>Cache</td>
                <td>Aucun</td>
                <td>Memorystore (Redis)</td>
                <td>Latence < 1ms sur requ√™tes fr√©quentes</td>
            </tr>
        </table>

        <h3>Zone Ingestion - Am√©liorations</h3>
        <table>
            <tr>
                <th>Composant</th>
                <th>Avant</th>
                <th>Apr√®s</th>
                <th>B√©n√©fice</th>
            </tr>
            <tr>
                <td>Pub/Sub Ingest</td>
                <td>Sans DLQ</td>
                <td>Avec Dead Letter Queue</td>
                <td>Pas de perte de messages en cas d'erreur</td>
            </tr>
            <tr>
                <td>Core Webhook</td>
                <td>Basic</td>
                <td>+ Idempotency check</td>
                <td>√âvite les doublons si webhook rejou√©</td>
            </tr>
        </table>

        <h3>Zone Traitement - Am√©liorations</h3>
        <table>
            <tr>
                <th>Composant</th>
                <th>Avant</th>
                <th>Apr√®s</th>
                <th>B√©n√©fice</th>
            </tr>
            <tr>
                <td>Pub/Sub Process</td>
                <td>Sans DLQ</td>
                <td>Avec Dead Letter Queue</td>
                <td>Retry automatique, analyse des √©checs</td>
            </tr>
            <tr>
                <td>Lectures Worker</td>
                <td>Sur master</td>
                <td>Sur Read Replica</td>
                <td>N'impacte pas les √©critures</td>
            </tr>
        </table>

        <h3>Zone Utilisateur - Am√©liorations</h3>
        <table>
            <tr>
                <th>Composant</th>
                <th>Avant</th>
                <th>Apr√®s</th>
                <th>B√©n√©fice</th>
            </tr>
            <tr>
                <td>Core API</td>
                <td>Acc√®s direct</td>
                <td>Via WAF + Load Balancer + Rate Limiting</td>
                <td>Protection, quotas par tenant</td>
            </tr>
            <tr>
                <td>Frontend</td>
                <td>Direct API</td>
                <td>Via Cloud Armor</td>
                <td>Protection DDoS</td>
            </tr>
        </table>

        <h2>üîê S√©curit√© - D√©tails</h2>

        <div class="security-note">
            <strong>‚ö†Ô∏è Donn√©es bancaires = Conformit√© obligatoire</strong>
            <p>RGPD, DSP2, et potentiellement PCI-DSS selon les donn√©es manipul√©es.</p>
        </div>

        <h3>Chiffrement</h3>
        <ul>
            <li><strong>In-Transit</strong> : TLS 1.3 partout (Cloud Run, Load Balancer)</li>
            <li><strong>At-Rest</strong> : Cloud SQL encryption par d√©faut + CMEK si n√©cessaire</li>
            <li><strong>Secrets</strong> : Secret Manager pour tous les credentials</li>
        </ul>

        <h3>Isolation R√©seau</h3>
        <ul>
            <li><strong>VPC Priv√©</strong> : Cloud SQL, Redis, Read Replica en IPs priv√©es</li>
            <li><strong>Private Service Connect</strong> : Connexion s√©curis√©e Cloud Run ‚Üí Cloud SQL</li>
            <li><strong>Firewall Rules</strong> : Seuls les services autoris√©s peuvent acc√©der √† la DB</li>
        </ul>

        <h3>Idempotency Store (Webhooks)</h3>
        <pre><code>-- Table pour √©viter les doublons de webhooks
CREATE TABLE webhook_events (
    event_id VARCHAR(255) PRIMARY KEY,
    provider VARCHAR(50) NOT NULL,
    received_at TIMESTAMP DEFAULT NOW(),
    processed BOOLEAN DEFAULT FALSE,
    payload JSONB
);

-- Usage: INSERT ... ON CONFLICT DO NOTHING</code></pre>

        <h3>Audit Trail</h3>
        <pre><code>-- Table d'audit pour tra√ßabilit√©
CREATE TABLE audit_log (
    id BIGSERIAL PRIMARY KEY,
    tenant_id UUID NOT NULL,
    user_id UUID,
    action VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id VARCHAR(255),
    old_values JSONB,
    new_values JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_audit_tenant_date ON audit_log(tenant_id, created_at DESC);</code></pre>

        <h2>üíÄ Dead Letter Queues - Strat√©gie</h2>

        <h3>Configuration Pub/Sub</h3>
        <pre><code># Topic principal
gcloud pubsub topics create ingest

# Dead Letter Topic
gcloud pubsub topics create ingest-dlq

# Subscription avec DLQ
gcloud pubsub subscriptions create ingest-sub \
    --topic=ingest \
    --dead-letter-topic=ingest-dlq \
    --max-delivery-attempts=5 \
    --ack-deadline=60</code></pre>

        <h3>Gestion des DLQ</h3>
        <ul>
            <li><strong>Monitoring</strong> : Alerting si messages dans DLQ > seuil</li>
            <li><strong>Analyse</strong> : Dashboard pour visualiser les erreurs</li>
            <li><strong>Replay</strong> : Possibilit√© de rejouer les messages apr√®s fix</li>
        </ul>

        <h2>‚ö° Cache Strategy</h2>

        <h3>Pattern Cache-Aside</h3>
        <pre><code>// Pseudo-code Core API
async function getTransactions(tenantId, filters) {
    const cacheKey = `transactions:${tenantId}:${hash(filters)}`;
    
    // 1. Check cache
    let data = await redis.get(cacheKey);
    if (data) return JSON.parse(data);
    
    // 2. Cache miss ‚Üí Query Read Replica
    data = await readReplica.query(
        'SELECT * FROM transactions WHERE tenant_id = $1 ...',
        [tenantId]
    );
    
    // 3. Store in cache (TTL: 5 minutes)
    await redis.setex(cacheKey, 300, JSON.stringify(data));
    
    return data;
}

// Invalidation on write
async function updateTransaction(id, data) {
    await cloudSQL.update('transactions', id, data);
    await redis.del(`transactions:${data.tenant_id}:*`); // Pattern delete
}</code></pre>

        <h3>Donn√©es √† cacher</h3>
        <table>
            <tr>
                <th>Donn√©e</th>
                <th>TTL</th>
                <th>Strat√©gie invalidation</th>
            </tr>
            <tr>
                <td>Liste transactions (dashboard)</td>
                <td>5 min</td>
                <td>Invalidation sur nouvelle transaction</td>
            </tr>
            <tr>
                <td>Stats r√©conciliation</td>
                <td>1 min</td>
                <td>Invalidation sur nouveau match</td>
            </tr>
            <tr>
                <td>Configuration tenant</td>
                <td>1 heure</td>
                <td>Invalidation sur modification</td>
            </tr>
            <tr>
                <td>User session data</td>
                <td>15 min</td>
                <td>Sliding expiration</td>
            </tr>
        </table>

        <h2>üìà Rate Limiting</h2>

        <h3>Configuration par tenant</h3>
        <table>
            <tr>
                <th>Plan</th>
                <th>Requests/min</th>
                <th>Requests/jour</th>
                <th>Upload max</th>
            </tr>
            <tr>
                <td>Free</td>
                <td>60</td>
                <td>1,000</td>
                <td>1 MB</td>
            </tr>
            <tr>
                <td>Pro</td>
                <td>300</td>
                <td>50,000</td>
                <td>10 MB</td>
            </tr>
            <tr>
                <td>Enterprise</td>
                <td>1,000</td>
                <td>Illimit√©</td>
                <td>100 MB</td>
            </tr>
        </table>

        <h3>Impl√©mentation (Redis)</h3>
        <pre><code>// Rate limiting avec sliding window
async function checkRateLimit(tenantId, plan) {
    const key = `ratelimit:${tenantId}:${currentMinute()}`;
    const current = await redis.incr(key);
    
    if (current === 1) {
        await redis.expire(key, 60);
    }
    
    const limit = LIMITS[plan].requestsPerMinute;
    if (current > limit) {
        throw new RateLimitError(`Rate limit exceeded: ${current}/${limit}`);
    }
}</code></pre>

        <h2>üìä Observabilit√© - Dashboards</h2>

        <h3>M√©triques Cl√©s (SLIs)</h3>
        <ul>
            <li><strong>Disponibilit√© API</strong> : % requ√™tes 2xx (cible: 99.9%)</li>
            <li><strong>Latence P99</strong> : Temps de r√©ponse (cible: < 500ms)</li>
            <li><strong>Taux de r√©conciliation</strong> : % transactions match√©es automatiquement</li>
            <li><strong>Erreurs ingestion</strong> : Messages en DLQ / total</li>
            <li><strong>Cache hit rate</strong> : % requ√™tes servies par cache (cible: > 80%)</li>
        </ul>

        <h3>Alertes Critiques</h3>
        <table>
            <tr>
                <th>Alerte</th>
                <th>Condition</th>
                <th>S√©v√©rit√©</th>
            </tr>
            <tr>
                <td>API Down</td>
                <td>Error rate > 5% pendant 5 min</td>
                <td class="priority-p0">P0 - Critical</td>
            </tr>
            <tr>
                <td>Cloud SQL Failover</td>
                <td>Basculement sur replica</td>
                <td class="priority-p0">P0 - Critical</td>
            </tr>
            <tr>
                <td>DLQ Growing</td>
                <td>> 100 messages en DLQ</td>
                <td class="priority-p1">P1 - High</td>
            </tr>
            <tr>
                <td>High Latency</td>
                <td>P99 > 2s pendant 10 min</td>
                <td class="priority-p1">P1 - High</td>
            </tr>
            <tr>
                <td>Cache Down</td>
                <td>Redis non disponible</td>
                <td class="priority-p2">P2 - Medium</td>
            </tr>
        </table>

        <h2>Micro-services Cloud Run</h2>
        <ul>
            <li><strong>Core API</strong> : API principale <strong>API-First</strong> (REST/GraphQL) pour :
                <ul>
                    <li>Requ√™tes utilisateur (CRUD)</li>
                    <li>Upload de fichiers CSV/JSON</li>
                    <li>Gestion des emails/alertes</li>
                    <li>Point d'entr√©e pour tous les clients (Frontend + API externes)</li>
                    <li><span class="priority-p1">+ Rate Limiting par tenant</span></li>
                    <li><span class="priority-p1">+ Cache-aside avec Redis</span></li>
                </ul>
            </li>
            <li><strong>Core Webhook</strong> : Service d√©di√© √† la r√©ception et validation des webhooks externes
                <ul>
                    <li><span class="priority-p1">+ Idempotency check</span></li>
                </ul>
            </li>
            <li><strong>Ingest Worker</strong> : Service d'ingestion qui √©crit les donn√©es dans Cloud SQL (toutes sources confondues)</li>
            <li><strong>Worker/Jobs</strong> : Service de traitement qui orchestre l'IA apr√®s ingestion compl√®te (√† venir)</li>
        </ul>

        <h2>L√©gende des Zones</h2>
        <ul>
            <li><strong>üîí Zone Edge (Protection)</strong> : WAF, Load Balancing, DDoS protection (Cloud Armor)</li>
            <li><strong>üîê Zone S√©curit√©</strong> : Secret Manager, VPC Priv√©, isolation r√©seau</li>
            <li><strong>üõ°Ô∏è Zone Ingestion (Async)</strong> : Point d'entr√©e asynchrone avec Dead Letter Queues</li>
            <li><strong>üíæ Zone Donn√©es (Master)</strong> : Cloud SQL HA + Read Replica + Redis Cache</li>
            <li><strong>üß† Zone Traitement (Worker)</strong> : Traitement asynchrone avec DLQ</li>
            <li><strong>üë§ Zone Utilisateur (API-First)</strong> : API avec rate limiting via Edge</li>
            <li><strong>üìä Zone Observabilit√©</strong> : Logging, Tracing, Monitoring, Alerting</li>
        </ul>

        <h2>Tables principales dans Cloud SQL</h2>
        <p>Cloud SQL (PostgreSQL) contient plusieurs tables organis√©es par domaine :</p>
        
        <h3>Tables Bancaires</h3>
        <ul>
            <li><strong>bank_connections</strong> : Connexions aux providers bancaires (Tink, etc.)</li>
            <li><strong>bank_accounts</strong> : Comptes bancaires li√©s aux connexions</li>
            <li><strong>transactions</strong> : Transactions bancaires (ou <code>transactions_unified</code> selon l'architecture)</li>
        </ul>

        <h3>Tables Factures/ERP</h3>
        <ul>
            <li><strong>invoices</strong> / <strong>factures</strong> : Factures provenant de l'ERP</li>
            <li><strong>external_data</strong> : Donn√©es externes (si architecture multi-sources)</li>
        </ul>

        <h3>Tables Relations/Matching</h3>
        <ul>
            <li><strong>data_relationships</strong> : Relations entre transactions et factures (matching IA)</li>
            <li><strong>reconciliation_matches</strong> : R√©sultats de r√©conciliation</li>
        </ul>

        <h3>Tables Syst√®me</h3>
        <ul>
            <li><strong>emails_queue</strong> / <strong>alerts_queue</strong> : Queue d'emails et alertes √† envoyer</li>
            <li><strong>data_ingestion_log</strong> : Logs d'ingestion pour tra√ßabilit√©</li>
            <li><strong>import_jobs</strong> : Suivi des imports CSV/JSON (statut, erreurs, etc.)</li>
            <li><strong>users</strong>, <strong>tenants</strong> : Gestion des utilisateurs et organisations</li>
            <li><strong class="priority-p1">webhook_events</strong> : Idempotency store pour webhooks (NOUVEAU)</li>
            <li><strong class="priority-p1">audit_log</strong> : Audit trail pour conformit√© (NOUVEAU)</li>
        </ul>

        <h2>Types de Composants</h2>
        <ul>
            <li><strong>Sources Externes</strong> (Rose) : Sources de donn√©es externes (Tink, ERP, Webhooks providers)</li>
            <li><strong>Edge</strong> (Rouge) : Protection p√©rim√©trique (WAF, Load Balancer)</li>
            <li><strong>Ingestion</strong> (Jaune) : Services d'ingestion avec DLQ</li>
            <li><strong>Stockage</strong> (Bleu) : Cloud SQL HA + Read Replica</li>
            <li><strong>Cache</strong> (Cyan) : Memorystore Redis</li>
            <li><strong>Traitement</strong> (Violet) : Workers avec DLQ</li>
            <li><strong>Utilisateur</strong> (Vert) : API et Frontend</li>
            <li><strong>S√©curit√©</strong> (Rouge fonc√©) : Secret Manager, VPC</li>
            <li><strong>Observabilit√©</strong> (Gris) : Logging, Tracing, Monitoring</li>
        </ul>

        <h2>Flux de Donn√©es (Mis √† jour)</h2>
        <ol>
            <li><strong>Ingestion Banques</strong> : Tink ‚Üí n8n ‚Üí Pub/Sub ‚Üí Ingest Worker ‚Üí Cloud SQL (+ DLQ si √©chec)</li>
            <li><strong>Ingestion Factures ERP</strong> : ERP ‚Üí n8n ‚Üí Pub/Sub ‚Üí Ingest Worker ‚Üí Cloud SQL</li>
            <li><strong>Webhooks</strong> : Providers ‚Üí <strong>Cloud Armor</strong> ‚Üí Core Webhook (+ idempotency) ‚Üí Pub/Sub ‚Üí Ingest Worker ‚Üí Cloud SQL</li>
            <li><strong>Upload CSV/JSON</strong> : Clients ‚Üí <strong>Cloud Armor</strong> ‚Üí <strong>Load Balancer</strong> ‚Üí Core API ‚Üí Pub/Sub ‚Üí Ingest Worker ‚Üí Cloud SQL</li>
            <li><strong>Traitement IA</strong> : Cloud SQL ‚Üí Pub/Sub ‚Üí Worker/Jobs ‚Üí <strong>Read Replica</strong> ‚Üí Vertex AI ‚Üí Cloud SQL (+ DLQ si √©chec)</li>
            <li><strong>Lecture Utilisateur</strong> : Frontend ‚Üí <strong>Cloud Armor</strong> ‚Üí Core API ‚Üí <strong>Redis</strong> ‚Üí (miss) ‚Üí <strong>Read Replica</strong></li>
            <li><strong>√âcriture Utilisateur</strong> : Frontend ‚Üí Cloud Armor ‚Üí Core API ‚Üí Cloud SQL ‚Üí <strong>Invalidation Redis</strong></li>
        </ol>

        <h2>Checklist de Mise en Production</h2>
        <table>
            <tr>
                <th>Priorit√©</th>
                <th>Action</th>
                <th>Statut</th>
            </tr>
            <tr>
                <td class="priority-p0">P0</td>
                <td>Activer Cloud SQL HA + PITR</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p0">P0</td>
                <td>Configurer Secret Manager pour credentials</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p0">P0</td>
                <td>Cr√©er VPC priv√© + Private Service Connect</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p0">P0</td>
                <td>Configurer Dead Letter Queues Pub/Sub</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p1">P1</td>
                <td>D√©ployer Cloud Armor (WAF)</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p1">P1</td>
                <td>Impl√©menter audit logging</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p1">P1</td>
                <td>Ajouter idempotency sur webhooks</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p1">P1</td>
                <td>Configurer rate limiting API</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p2">P2</td>
                <td>D√©ployer Memorystore (Redis)</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
            <tr>
                <td class="priority-p2">P2</td>
                <td>Configurer Cloud Trace + dashboards</td>
                <td>‚¨ú √Ä faire</td>
            </tr>
        </table>

        <h2>Architecture API-First</h2>
        
        <h3>Principe</h3>
        <p>L'application suit une architecture <strong>API-First</strong> : <strong>Core API</strong> est le point d'entr√©e unique pour tous les clients (Frontend, clients externes, int√©grations).</p>
        
        <h3>Avantages</h3>
        <ul>
            <li>‚úÖ <strong>R√©utilisabilit√©</strong> : L'API peut √™tre utilis√©e par diff√©rents clients (web, mobile, int√©grations)</li>
            <li>‚úÖ <strong>D√©couplage</strong> : Le Frontend et les autres clients sont ind√©pendants</li>
            <li>‚úÖ <strong>√âvolutivit√©</strong> : Facile d'ajouter de nouveaux clients sans modifier le backend</li>
            <li>‚úÖ <strong>Documentation</strong> : API document√©e (OpenAPI/Swagger) pour faciliter l'int√©gration</li>
            <li>‚úÖ <strong>Versioning</strong> : Support de plusieurs versions d'API (<code>/api/v1/</code>, <code>/api/v2/</code>)</li>
        </ul>

        <h3>Endpoints Principaux de Core API</h3>
        
        <h4>1. CRUD Standard</h4>
        <ul>
            <li><code>GET /api/v1/transactions</code> - Liste des transactions</li>
            <li><code>GET /api/v1/transactions/:id</code> - D√©tail d'une transaction</li>
            <li><code>POST /api/v1/transactions</code> - Cr√©er une transaction</li>
            <li><code>PUT /api/v1/transactions/:id</code> - Mettre √† jour</li>
            <li><code>DELETE /api/v1/transactions/:id</code> - Supprimer</li>
        </ul>

        <h4>2. Upload de Fichiers CSV/JSON</h4>
        <ul>
            <li><code>POST /api/v1/ingest/upload</code> - Upload CSV/JSON
                <ul>
                    <li>Accepte : <code>multipart/form-data</code> (fichier) ou JSON (donn√©es directes)</li>
                    <li>Formats support√©s : CSV, JSON</li>
                    <li>Validation automatique</li>
                    <li>Parsing et normalisation</li>
                    <li>Envoi dans Pub/Sub pour traitement asynchrone</li>
                </ul>
            </li>
        </ul>

        <h4>3. Export de Donn√©es</h4>
        <ul>
            <li><code>GET /api/v1/export/transactions</code> - Export CSV/JSON</li>
            <li><code>GET /api/v1/export/factures</code> - Export factures</li>
        </ul>

        <h3>Authentification</h3>
        <ul>
            <li><strong>Firebase Auth</strong> pour le Frontend (JWT tokens)</li>
            <li><strong>API Keys</strong> ou <strong>OAuth2</strong> pour les clients externes</li>
            <li>Chaque requ√™te authentifi√©e avec <code>tenant_id</code> pour isolation multi-tenant</li>
        </ul>

        <h2>Import CSV/JSON - Impl√©mentation</h2>
        
        <h3>Flow d'Import</h3>
        <ol>
            <li><strong>Upload</strong> : Client envoie fichier CSV/JSON √† <code>POST /api/v1/ingest/upload</code></li>
            <li><strong>Validation</strong> : Core API valide le format et le sch√©ma</li>
            <li><strong>Parsing</strong> : Extraction et normalisation des donn√©es</li>
            <li><strong>Queue</strong> : Envoi dans Pub/Sub (Topic: ingest)</li>
            <li><strong>Traitement</strong> : Ingest Worker traite de mani√®re asynchrone</li>
            <li><strong>Stockage</strong> : √âcriture dans Cloud SQL</li>
            <li><strong>R√©ponse</strong> : Statut de l'upload retourn√© au client</li>
            <li><strong>En cas d'√©chec</strong> : Message envoy√© en DLQ pour analyse</li>
        </ol>

        <h3>Modifications Techniques N√©cessaires</h3>
        
        <h4>1. Core API - Nouveau Endpoint</h4>
        <p>Ajouter un endpoint <code>POST /api/v1/ingest/upload</code> pour recevoir les fichiers CSV/JSON, les parser, valider et les envoyer dans Pub/Sub.</p>
        
        <h4>2. Service de Parsing</h4>
        <ul>
            <li><strong>CSV</strong> : Utiliser <code>csv-parse</code> ou <code>papaparse</code></li>
            <li><strong>JSON</strong> : Parsing natif + validation JSON Schema</li>
            <li><strong>Normalisation</strong> : Adapter au format interne</li>
        </ul>

        <h4>3. Validation</h4>
        <ul>
            <li><strong>JSON Schema</strong> pour valider la structure</li>
            <li><strong>Business Rules</strong> (montants valides, dates, etc.)</li>
            <li><strong>Limites</strong> : Taille max fichier, nombre de lignes (selon plan)</li>
        </ul>

        <h4>4. Table de Monitoring</h4>
        <p>Ajouter une table <code>import_jobs</code> dans Cloud SQL pour tracker les imports avec statut : <code>pending</code>, <code>processing</code>, <code>completed</code>, <code>failed</code>.</p>
    </div>
</body>
</html>
